<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: services/profileio.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Demo","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Demo</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="m3d.controller.MapController">
            <span class="title">
                <a href="m3d.controller.MapController.html">m3d.controller.MapController</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controller.ProfileController">
            <span class="title">
                <a href="m3d.controller.ProfileController.html">m3d.controller.ProfileController</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ProfileIOService">
            <span class="title">
                <a href="m3d.services.ProfileIOService.html">m3d.services.ProfileIOService</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ProfileIOService#init"><a href="m3d.services.ProfileIOService.html#init">init</a></li>
            
                <li data-name="m3d.services.ProfileIOService#load"><a href="m3d.services.ProfileIOService.html#load">load</a></li>
            
                <li data-name="m3d.services.ProfileIOService#save"><a href="m3d.services.ProfileIOService.html#save">save</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ProfileOutlineService">
            <span class="title">
                <a href="m3d.services.ProfileOutlineService.html">m3d.services.ProfileOutlineService</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ProfileOutlineService#calculateRasterPoints"><a href="m3d.services.ProfileOutlineService.html#calculateRasterPoints">calculateRasterPoints</a></li>
            
                <li data-name="m3d.services.ProfileOutlineService#createShape"><a href="m3d.services.ProfileOutlineService.html#createShape">createShape</a></li>
            
                <li data-name="m3d.services.ProfileOutlineService#getCommonVertices"><a href="m3d.services.ProfileOutlineService.html#getCommonVertices">getCommonVertices</a></li>
            
                <li data-name="m3d.services.ProfileOutlineService#getTopVertices"><a href="m3d.services.ProfileOutlineService.html#getTopVertices">getTopVertices</a></li>
            
                <li data-name="m3d.services.ProfileOutlineService#invert"><a href="m3d.services.ProfileOutlineService.html#invert">invert</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controller.GemeindeController">
            <span class="title">
                <a href="m3d.controller.GemeindeController.html">m3d.controller.GemeindeController</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controller.MenuController">
            <span class="title">
                <a href="m3d.controller.MenuController.html">m3d.controller.MenuController</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.controller.MenuController#init"><a href="m3d.controller.MenuController.html#init">init</a></li>
            
                <li data-name="m3d.controller.MenuController#loadModel"><a href="m3d.controller.MenuController.html#loadModel">loadModel</a></li>
            
                <li data-name="m3d.controller.MenuController#render"><a href="m3d.controller.MenuController.html#render">render</a></li>
            
                <li data-name="m3d.controller.MenuController#saveModel"><a href="m3d.controller.MenuController.html#saveModel">saveModel</a></li>
            
                <li data-name="m3d.controller.MenuController#toggleInvert"><a href="m3d.controller.MenuController.html#toggleInvert">toggleInvert</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controllers.SettingsController">
            <span class="title">
                <a href="m3d.controllers.SettingsController.html">m3d.controllers.SettingsController</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.model.Footprint">
            <span class="title">
                <a href="m3d.model.Footprint.html">m3d.model.Footprint</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.model.Footprint">
            <span class="title">
                <a href="m3d.model.Footprint.html">m3d.model.Footprint</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.model.Footprint">
            <span class="title">
                <a href="m3d.model.Footprint.html">m3d.model.Footprint</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.model.Profile">
            <span class="title">
                <a href="m3d.model.Profile.html">m3d.model.Profile</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.model.Profile#getBottomIndex"><a href="m3d.model.Profile.html#getBottomIndex">getBottomIndex</a></li>
            
                <li data-name="m3d.model.Profile#getBottomVertex"><a href="m3d.model.Profile.html#getBottomVertex">getBottomVertex</a></li>
            
                <li data-name="m3d.model.Profile#getDimensionX"><a href="m3d.model.Profile.html#getDimensionX">getDimensionX</a></li>
            
                <li data-name="m3d.model.Profile#getDimensionY"><a href="m3d.model.Profile.html#getDimensionY">getDimensionY</a></li>
            
                <li data-name="m3d.model.Profile#getDimensionZ"><a href="m3d.model.Profile.html#getDimensionZ">getDimensionZ</a></li>
            
                <li data-name="m3d.model.Profile#getDistanceX"><a href="m3d.model.Profile.html#getDistanceX">getDistanceX</a></li>
            
                <li data-name="m3d.model.Profile#getDistanceY"><a href="m3d.model.Profile.html#getDistanceY">getDistanceY</a></li>
            
                <li data-name="m3d.model.Profile#getDistanceZ"><a href="m3d.model.Profile.html#getDistanceZ">getDistanceZ</a></li>
            
                <li data-name="m3d.model.Profile#getMaxElv"><a href="m3d.model.Profile.html#getMaxElv">getMaxElv</a></li>
            
                <li data-name="m3d.model.Profile#getMaxLat"><a href="m3d.model.Profile.html#getMaxLat">getMaxLat</a></li>
            
                <li data-name="m3d.model.Profile#getMaxLng"><a href="m3d.model.Profile.html#getMaxLng">getMaxLng</a></li>
            
                <li data-name="m3d.model.Profile#getMinLat"><a href="m3d.model.Profile.html#getMinLat">getMinLat</a></li>
            
                <li data-name="m3d.model.Profile#getMinLng"><a href="m3d.model.Profile.html#getMinLng">getMinLng</a></li>
            
                <li data-name="m3d.model.Profile#init"><a href="m3d.model.Profile.html#init">init</a></li>
            
                <li data-name="m3d.model.Profile#rotate"><a href="m3d.model.Profile.html#rotate">rotate</a></li>
            
                <li data-name="m3d.model.Profile#updateMesh"><a href="m3d.model.Profile.html#updateMesh">updateMesh</a></li>
            
                <li data-name="m3d.model.Profile#updateProfilePoints"><a href="m3d.model.Profile.html#updateProfilePoints">updateProfilePoints</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.models.ProfilePoint">
            <span class="title">
                <a href="m3d.models.ProfilePoint.html">m3d.models.ProfilePoint</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ElevationDataService">
            <span class="title">
                <a href="m3d.services.ElevationDataService.html">m3d.services.ElevationDataService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="MultiGeometry">
            <span class="title">
                <a href="MultiGeometry.html">MultiGeometry</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="profileio.js.html">Source: services/profileio.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>'use strict';
define([
   'angular'
  ,'threejs'
  ,'models/m3dProfile'
  ,'lodash'
  ,'services/STLLoader'
  ,'services/VRMLLoader'
  ,'util/FileSaver.min'
  ,'vendor/three/ThreeCSG'
  ], 
  function (angular, THREE, Profile, _) {

    var $log, $rootScope;
    var loader;

    /**
     * ProfileIOService
     * Service to load and save files from/to file
     * @class
     * @name m3d.services.ProfileIOService 
     * @constructor
     * @namespace
     */
    var ProfileIOService = function($log, $rootScope){
      $log.debug('ProfileIOService created...');
      this.init($log, $rootScope);
    };

    ProfileIOService.prototype = /** @lends m3d.services.ProfileIOService.prototype */{
      /**
      * initialize
      */
      init: function(logger, scope){
        $log = logger;
        $rootScope = scope;
        $rootScope.$on('menu:model:load', this.load);        
      },

      /**
      * load model from file
      * @param {m3d.events.io} event the event that was fired
      * @fires io:model:loaded
      */
      load: function(event, file){
        $log.debug('Loading from ' + file.name + ' ...');
        var callback;
        switch(true){
          case new RegExp('.stl').test(file.name):
            loader = new THREE.STLLoader();
            callback = onStlLoaded;
            break;
          case new RegExp('.wrl').test(file.name):
            loader = new THREE.VRMLLoader();
            callback = onVrmlLoaded;
            break;
        }
        if(loader)
          loader.loadLocal(file, callback);
      },

      /**
      * save model to file
      * @param {m3d.models.Profile[]} profiles the profiles to be saved. Each object will be saved to a separate file.
      */
      save: function(m3dProfile){
        var fileName = m3dProfile.name || 'stlModel';
        fileName += '_generated';
        $log.debug('Saving model to ' + fileName + '.stl ...');
        var stlString = generateStl(m3dProfile.mesh.geometry);
        // Bug in PhantomJS: https://github.com/ariya/phantomjs/issues/11013
        var blob;
        if (typeof WebKitBlobBuilder !== 'undefined'){
          var builder = new WebKitBlobBuilder();
          builder.append(stlString);
          blob = builder.getBlob();
        }
        // funktioniert nur in Browsern
        else {
          blob = new Blob([stlString], {type: 'text/plain'});
        }
        
        window.saveAs(blob, fileName + '.stl');
      }
    };

    var onStlLoaded = function(geometry, file){
      var fileName = file.name.substr(0, file.name.lastIndexOf('.'));
      var mesh = new THREE.Mesh(geometry, new THREE.MeshPhongMaterial({color: 0x00ff00, dynamic: true, shading: THREE.FlatShading}));
      mesh.geometry.mergeVertices();
      mesh.geometry.computeVertexNormals();
      var profile = new Profile({
        mesh: mesh,
        name: fileName
      });
      $rootScope.$broadcast('io:model:loaded', profile);
    };

    var onVrmlLoaded = function(content, file){
      var fileName = file.name.substr(0, file.name.lastIndexOf('.'));
      //var scene = content.geometry;
      //var objects = content.geometry.children;
    };

    var generateStl = function(geometry){
      var stl = 'solid pixel\n';

      var stringifyVector = function(vec){
          return ''+vec.x+' '+vec.y+' '+vec.z;
      };
      var stringifyVertex = function(vec){
          return 'vertex ' + vec.x + ' ' + vec.y + ' ' + vec.z + ' \n';
      };

      var vertices, tris, i;
      if (geometry instanceof THREE.BufferGeometry){        
        var positions = geometry.getAttribute('position').array;
        var normals = geometry.getAttribute('normal').array;
        for (i=0; i&lt; normals.length; i+=3*3){         
          var n1 = normals[i];
          var n2 = normals[i+1];
          var n3 = normals[i+2];
          stl += ('facet normal '+n1+' '+n2+' '+n3+' \n');
            stl += ('outer loop \n');

          for (var j=i; j&lt;i+9; j+=3){
            var x = positions[j];
            var y = positions[j+1];
            var z = positions[j+2];
            stl += 'vertex '+x+' '+y+' '+z+' \n';
          }
          stl += ('endloop \n');
          stl += ('endfacet \n');         
        }
      }
      else {
        vertices = geometry.vertices;
        tris     = geometry.faces;
        for(i = 0; i&lt;tris.length; i++){
          stl += ('facet normal '+stringifyVector( tris[i].normal )+' \n');
          stl += ('outer loop \n');
          stl += stringifyVertex( vertices[ tris[i].a ]);
          stl += stringifyVertex( vertices[ tris[i].b ]);
          stl += stringifyVertex( vertices[ tris[i].c ]);
          stl += ('endloop \n');
          stl += ('endfacet \n');
        }
      }         
      stl += ('endsolid');

      return stl;
    };

    return ['$log', '$rootScope', ProfileIOService];    
});

/**
* This event indicates that a model has been loaded
* @name m3d.events.io
* @event io:model:loaded
* @property {THREE.geometry} geometry of the model
* @property {String} fileName name of the file the model was loaded from
*/</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Thu Feb 26 2015 20:30:51 GMT-0000 (UTC)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
