<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: services/elevationdataservice.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Demo","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Demo</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="m3d.services.ProfileIOService">
            <span class="title">
                <a href="m3d.services.ProfileIOService.html">m3d.services.ProfileIOService</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ProfileIOService#init"><a href="m3d.services.ProfileIOService.html#init">init</a></li>
            
                <li data-name="m3d.services.ProfileIOService#load"><a href="m3d.services.ProfileIOService.html#load">load</a></li>
            
                <li data-name="m3d.services.ProfileIOService#save"><a href="m3d.services.ProfileIOService.html#save">save</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ElevationDataService">
            <span class="title">
                <a href="m3d.services.ElevationDataService.html">m3d.services.ElevationDataService</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="m3d.services.ElevationDataService#CHUNK_SIZE"><a href="m3d.services.ElevationDataService.html#CHUNK_SIZE">CHUNK_SIZE</a></li>
            
                <li data-name="m3d.services.ElevationDataService#DELAY"><a href="m3d.services.ElevationDataService.html#DELAY">DELAY</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ElevationDataService#calculateHeightMap"><a href="m3d.services.ElevationDataService.html#calculateHeightMap">calculateHeightMap</a></li>
            
                <li data-name="m3d.services.ElevationDataService#init"><a href="m3d.services.ElevationDataService.html#init">init</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="elevationdataservice.js.html">Source: services/elevationdataservice.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>define([
  'angular',
  'jquery',
  'lodash'  
  ], 
  function (angular, $, _) {
    'use strict';

    var google = window.google;
    var service, coords;
    var $log, $rootScope;
    var stop, index, requestQueue, queueItem;

    /**
     * ElevationDataService
     * Default Service to get elevation data from Google
     * @class
     * @name m3d.services.ElevationDataService 
     */
    var ElevationDataService = function($log, $rootScope){
      $log.debug('HeightMapService created');
      this.init($log, $rootScope);
    };
    

    ElevationDataService.prototype = /** @lends m3d.services.ElevationDataService.prototype */ {
      /** 
      * Default delay between service calls in ms 
      * @static 
      */
      DELAY: 1010,
      /** 
      * Number of coordinates to process in one go
      * @static 
      */
      CHUNK_SIZE: 150,

      /**
      * initialize Service
      */
      init: function(log, rootScope){
        $log = log;
        $rootScope = rootScope;
      },

      /**
      * Calculate a height map from a list of coordinates
      * @param {Object[]} coordinates list of coordinates to process      
      * @fires adapter:start
      * @fires adapter:end
      * @fires adapter:queue:progress
      */
      calculateHeightMap: function(coordinates){
        $log.debug('calculating heigth map in service ...');
        $log.debug(coordinates.length + ' points');
        coords = coordinates;

        service = new google.maps.ElevationService();

        // Koordinaten-Array aufsplitten (max 512 coordinates pro request)
        var delay = 1010;

        var chunkSize = 150;
        requestQueue = [];
        for(var i=0; i&lt;coordinates.length; i+=chunkSize){
          requestQueue.push(coordinates.slice(i, i+chunkSize));
        }
        
        $rootScope.$broadcast('adapter:start', {
           numItems: coordinates.length
          ,numCalls: requestQueue.length
          ,chunkSize: chunkSize
          ,delay: delay
        });
        
        stop = false;
        index = 0;
        processNextQueueItem();        
      }
    };

    // Queue-Item abarbeiten
    var processNextQueueItem = function(){
      if (stop || index >= requestQueue.length){
        stop = false;
        $rootScope.$broadcast('adapter:end', coords);
      }
      else{
        queueItem = requestQueue[index];
        var request = {locations: queueItem};
        service.getElevationForLocations(request, onServiceResponse);           
      }
    };    

      // Response handler
    var onServiceResponse = function(result, status){
        $rootScope.$broadcast('adapter:queue:progress', {
           status: status
          ,progress: index+1
          ,total: requestQueue.length
        });
        switch(status){
          case google.maps.ElevationStatus.OK:              

            $.each(queueItem, function(i, coord){              
              var searchResult = $.grep(result, function(entry, index){
                var lat = Number(parseFloat(entry.location.lat())).toFixed(4);
                var lng = Number(parseFloat(entry.location.lng())).toFixed(4);
                return lat == coord.lat && lng == coord.lng;
              });
              if (searchResult && searchResult.length > 0){
                $rootScope.$broadcast('adapter:item:progress');
                coord.elv = searchResult[0].elevation;
              }                
            });

            stop = ++index >= requestQueue.length
            processNextQueueItem();
          break;

          default:
            setTimeout(processNextQueueItem, 1000);
          break;
        }
        
    };


    return ElevationDataService;
});

/**
* Adapter start event.
* This event indicates the start of processing a number of coordinates
* @event adapter:start
* @property {Number} numItems number of coordinates that are going to be processed
* @property {Number} numCalls number of calls that are going to be made to get elevation data
* @property {Number} chunkSize number of coordinates processed in one go
* @property {Number} delay delay between service calls in ms
*/

/**
* Adapter progress event.
* This event indicates a progress while processing a number of coordinates
* @event adapter:queue:progress
* @property {Number} status Status response of last service call
* @property {Number} progress number of calls made
* @property {Number} total number of calls to be made
*/

/**
* Adapter end event.
* This event indicates the end of processing a number of coordinates
* @event adapter:end
* @property {Object[]} coords the processed coordinates including their elevation
*/</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Thu Jan 29 2015 06:50:14 GMT-0000 (UTC)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
