<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: services/profileOutline.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Demo","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Demo</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="m3d.controller.MapController">
            <span class="title">
                <a href="m3d.controller.MapController.html">m3d.controller.MapController</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.controller.MapController#getCoordinates"><a href="m3d.controller.MapController.html#getCoordinates">getCoordinates</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controller.ProfileController">
            <span class="title">
                <a href="m3d.controller.ProfileController.html">m3d.controller.ProfileController</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ProfileIOService">
            <span class="title">
                <a href="m3d.services.ProfileIOService.html">m3d.services.ProfileIOService</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ProfileIOService#init"><a href="m3d.services.ProfileIOService.html#init">init</a></li>
            
                <li data-name="m3d.services.ProfileIOService#load"><a href="m3d.services.ProfileIOService.html#load">load</a></li>
            
                <li data-name="m3d.services.ProfileIOService#save"><a href="m3d.services.ProfileIOService.html#save">save</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ProfileOutlineService">
            <span class="title">
                <a href="m3d.services.ProfileOutlineService.html">m3d.services.ProfileOutlineService</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ProfileOutlineService#invert"><a href="m3d.services.ProfileOutlineService.html#invert">invert</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controller.GemeindeController">
            <span class="title">
                <a href="m3d.controller.GemeindeController.html">m3d.controller.GemeindeController</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.controller.GemeindeController#init"><a href="m3d.controller.GemeindeController.html#init">init</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controller.MenuController">
            <span class="title">
                <a href="m3d.controller.MenuController.html">m3d.controller.MenuController</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.controller.MenuController#init"><a href="m3d.controller.MenuController.html#init">init</a></li>
            
                <li data-name="m3d.controller.MenuController#loadModel"><a href="m3d.controller.MenuController.html#loadModel">loadModel</a></li>
            
                <li data-name="m3d.controller.MenuController#render"><a href="m3d.controller.MenuController.html#render">render</a></li>
            
                <li data-name="m3d.controller.MenuController#saveModel"><a href="m3d.controller.MenuController.html#saveModel">saveModel</a></li>
            
                <li data-name="m3d.controller.MenuController#toggleInvert"><a href="m3d.controller.MenuController.html#toggleInvert">toggleInvert</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.controllers.SettingsController">
            <span class="title">
                <a href="m3d.controllers.SettingsController.html">m3d.controllers.SettingsController</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.model.Profile">
            <span class="title">
                <a href="m3d.model.Profile.html">m3d.model.Profile</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.model.Profile#getBottomIndex"><a href="m3d.model.Profile.html#getBottomIndex">getBottomIndex</a></li>
            
                <li data-name="m3d.model.Profile#getBottomVertex"><a href="m3d.model.Profile.html#getBottomVertex">getBottomVertex</a></li>
            
                <li data-name="m3d.model.Profile#getDimensionX"><a href="m3d.model.Profile.html#getDimensionX">getDimensionX</a></li>
            
                <li data-name="m3d.model.Profile#getDimensionY"><a href="m3d.model.Profile.html#getDimensionY">getDimensionY</a></li>
            
                <li data-name="m3d.model.Profile#getDimensionZ"><a href="m3d.model.Profile.html#getDimensionZ">getDimensionZ</a></li>
            
                <li data-name="m3d.model.Profile#getDistanceX"><a href="m3d.model.Profile.html#getDistanceX">getDistanceX</a></li>
            
                <li data-name="m3d.model.Profile#getDistanceY"><a href="m3d.model.Profile.html#getDistanceY">getDistanceY</a></li>
            
                <li data-name="m3d.model.Profile#getDistanceZ"><a href="m3d.model.Profile.html#getDistanceZ">getDistanceZ</a></li>
            
                <li data-name="m3d.model.Profile#getMaxElv"><a href="m3d.model.Profile.html#getMaxElv">getMaxElv</a></li>
            
                <li data-name="m3d.model.Profile#getMaxLat"><a href="m3d.model.Profile.html#getMaxLat">getMaxLat</a></li>
            
                <li data-name="m3d.model.Profile#getMaxLng"><a href="m3d.model.Profile.html#getMaxLng">getMaxLng</a></li>
            
                <li data-name="m3d.model.Profile#getMinLat"><a href="m3d.model.Profile.html#getMinLat">getMinLat</a></li>
            
                <li data-name="m3d.model.Profile#getMinLng"><a href="m3d.model.Profile.html#getMinLng">getMinLng</a></li>
            
                <li data-name="m3d.model.Profile#init"><a href="m3d.model.Profile.html#init">init</a></li>
            
                <li data-name="m3d.model.Profile#rotate"><a href="m3d.model.Profile.html#rotate">rotate</a></li>
            
                <li data-name="m3d.model.Profile#updateMesh"><a href="m3d.model.Profile.html#updateMesh">updateMesh</a></li>
            
                <li data-name="m3d.model.Profile#updateProfilePoints"><a href="m3d.model.Profile.html#updateProfilePoints">updateProfilePoints</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.models.ProfilePoint">
            <span class="title">
                <a href="m3d.models.ProfilePoint.html">m3d.models.ProfilePoint</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="m3d.services.ElevationDataService">
            <span class="title">
                <a href="m3d.services.ElevationDataService.html">m3d.services.ElevationDataService</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="m3d.services.ElevationDataService#CHUNK_SIZE"><a href="m3d.services.ElevationDataService.html#CHUNK_SIZE">CHUNK_SIZE</a></li>
            
                <li data-name="m3d.services.ElevationDataService#DELAY"><a href="m3d.services.ElevationDataService.html#DELAY">DELAY</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="m3d.services.ElevationDataService#getElevationData"><a href="m3d.services.ElevationDataService.html#getElevationData">getElevationData</a></li>
            
                <li data-name="m3d.services.ElevationDataService#init"><a href="m3d.services.ElevationDataService.html#init">init</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="MultiGeometry">
            <span class="title">
                <a href="MultiGeometry.html">MultiGeometry</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="profileOutline.js.html">Source: services/profileOutline.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>'use strict'
define([
   'angular'
  ,'threejs'  
  ,'lodash'
  ,'models/m3dProfile'
  ],
  function(angular, THREE, _, Profile){

    var extrudeSettings = { 
      amount: 40, 
      bevelEnabled: true, 
      bevelSegments: 2, 
      steps: 2, 
      bevelSize: 1, 
      bevelThickness: 1 
    };

    var $log;
    /**
     * ProfileOutlineService
     * Service to load and save files from/to file
     * @class
     * @name m3d.services.ProfileOutlineService 
     * @constructor
     * @namespace
     */
    var ProfileOutlineService = function(log){
      $log = log;
    };

    ProfileOutlineService.prototype = /** @lends m3d.services.ProfileOutlineService.prototype */{

      createProfile: function(profilePoints){
        var profile = new Profile({
          profilePoints: profilePoints,
          thickness: localStorage.getItem('thickness') || undefined
        });
        return profile;
      },

      createOutline: function(points){
        $log.debug('creating outline for ' + points.length + ' coordinates');            

        var maxLat = _.max(points, 'lat').lat;
        var maxLng = _.max(points, 'lng').lng;
        var minLat = _.min(points, 'lat').lat;
        var minLng = _.min(points, 'lng').lng;

        var scale = 50000;
        var shape = new THREE.Shape();
        _.forEach(points, function(point, i){
          var x = (point.lat-maxLat) * scale;
          var y = (point.lng-maxLng) * scale;
          shape.moveTo(x, y);
        });

        var posX, posY=0;
        posX = (maxLng - minLng)*scale/2;
        posY = (maxLat - minLat)*-scale/2;        
        var extrudedMesh = this.extrude(shape, extrudeSettings, posX, 0, posY);
        var mesh = this.rasterize(extrudedMesh);
        return mesh;
      },

      extrude: function(shape, extrudeSettings, x, y, z){
        var flatGeometry = new THREE.ShapeGeometry(shape);
        var geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
        var mesh = new THREE.Mesh(geometry, new THREE.MeshPhongMaterial( { color: 0x00ff00, ambient: 0x00ff00 } ));

        mesh.geometry.dynamic = true;

        var rotationX = new THREE.Matrix4().makeRotationX( Math.PI/2 );
        var rotationY = new THREE.Matrix4().makeRotationY( Math.PI/2 );

        mesh.updateMatrix();
        mesh.geometry.applyMatrix(mesh.matrix);
        mesh.geometry.applyMatrix(rotationX);
        mesh.geometry.applyMatrix(rotationY);
        mesh.geometry.applyMatrix(new THREE.Matrix4().makeTranslation(x,y,z));
        mesh.matrix.identity();

        return mesh;
      },

      rasterize: function(extrudedMesh){
        var maxX = _.max(extrudedMesh.geometry.vertices, 'x').x;
        var minX = _.min(extrudedMesh.geometry.vertices, 'x').x;
        var maxY = _.max(extrudedMesh.geometry.vertices, 'y').y;
        var minY = _.min(extrudedMesh.geometry.vertices, 'y').y;        
        var maxZ = _.max(extrudedMesh.geometry.vertices, 'z').z;
        var minZ = _.min(extrudedMesh.geometry.vertices, 'z').z;

        var boxWidth = maxX - minX;
        var boxHeight = (maxY - minY)/2;
        var boxDepth = maxZ - minZ;

        var boxGeometry = new THREE.BoxGeometry(boxWidth, boxHeight, boxDepth, 10, 1, 10);
        var material = new THREE.MeshPhongMaterial({color: 0x00ff00, dynamic: true, wireframe: false });
        //var boxMesh = new THREE.Mesh(boxGeometry, material);

        var csgBox = new THREE.ThreeBSP(boxGeometry);
        var csgProfile = new THREE.ThreeBSP(extrudedMesh);
        var csgRasterized = csgBox.intersect(csgProfile);
        var geometry = csgRasterized.toGeometry();
        
        var rasterized = new THREE.Mesh(geometry, material);
        return rasterized;
      },

      /**
      * create a mold by inverting the objects
      * @param {m3d.models.Profile} profile the profile to be inverted
      */
      invert: function(profile){
        profile.mesh.geometry.computeVertexNormals();
        // Quader für Gussform vorbereiten
        var boxBorderThickness = profile.getDimensionY() * 1.1 - profile.getDimensionY();
        var boxWidth = profile.getDimensionZ() + boxBorderThickness;
        var boxHeight = profile.getDimensionY() * 2 + boxBorderThickness;
        var boxDepth =  profile.getDimensionX() + boxBorderThickness;
        var boxGeometry = new THREE.BoxGeometry(boxDepth, boxHeight, boxWidth);
        boxGeometry.dynamic = true;
        // y-Position der unteren Vertices anpassen
        boxGeometry.vertices.forEach(function(vertex){
          if (vertex.y &lt; 0)
            vertex.y = -1 * boxBorderThickness;
        });
        boxGeometry.verticesNeedUpdate = true;

        // Modell kopieren und Sockel erstellen
        profile.mesh.geometry.computeVertexNormals();
        var profileCopy = new Profile({
          profilePoints: profile.profilePoints,
          mesh: profile.mesh
        });   
        profile.mesh.geometry.computeVertexNormals();
        profileCopy.mesh.geometry.computeVertexNormals();

        profileCopy.mesh.dynamic = true;

        profile.mesh.geometry.computeVertexNormals();
        profileCopy.mesh.geometry.computeVertexNormals();

        // Sockel erstellen
        if (profileCopy.profilePoints.length > 0){
        _.forEach(profileCopy.profilePoints, function(point, i){
              var bottomIndex = profileCopy.getBottomIndex(i);                        
            profileCopy.mesh.geometry.vertices[bottomIndex].y = -1 * boxHeight;
            });   
        } 
        else{
          var half = Math.ceil(profileCopy.mesh.geometry.vertices.length / 2);
          var getBoti = function(n){        
            var side = Math.sqrt(half);       
            return half + n + side - 2*(n%side) - 1;
          }
          for(var i=0; i&lt;half; i++){
            var boti = getBoti(i);
            profileCopy.mesh.geometry.vertices[boti].y = -1 * boxHeight;
          }
        };    
        //profileCopy.mesh = profile.mesh;
        profileCopy.mesh.geometry.verticesNeedUpdate = true;
        profileCopy.mesh.geometry.mergeVertices();
        profileCopy.mesh.geometry.computeVertexNormals();

        // Gussform aus Quader konstruieren          
        var csgBox = new THREE.ThreeBSP(boxGeometry);
        var csgProfile = new THREE.ThreeBSP(profileCopy.mesh);
        var csgMold = csgBox.subtract(csgProfile);
        var geometry = csgMold.toGeometry();

        var material = new THREE.MeshPhongMaterial({color: 0x00ff00, dynamic: true });
        var mold = new THREE.Mesh(geometry, material);

        // Gussform um 180° drehen
        var moldRotation = new THREE.Matrix4().makeRotationX( Math.PI );
        mold.updateMatrix();
        mold.geometry.applyMatrix(mold.matrix);
        mold.geometry.applyMatrix(moldRotation);
        mold.matrix.identity();
        mold.name = profile.mesh.name + 'mold';
        return mold;
      }

    };

    /**
    * only used for testing
    */
    var createCircle = function(){
      var circle = new THREE.Shape();
      var radius = 6;

      for (var i = 0; i &lt; 16; i++) {
        var pct = (i + 1) / 16;
        var theta = pct * Math.PI * 2.0;
        var x = radius * Math.cos(theta);
        var y = radius * Math.sin(theta);
        if (i == 0) {
          circle.moveTo(x, y);
        } else {
          circle.lineTo(x, y);
        }
      }

      return circle.makeGeometry();
    };

    return ['$log', ProfileOutlineService];
});</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Mon Feb 16 2015 15:22:23 GMT-0000 (UTC)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
